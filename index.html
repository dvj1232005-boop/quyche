<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">

<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>An Quy Cháº¿ â€“ ÄÄƒng kÃ½ ca lÃ m</title>

<meta name="theme-color" content="#0b3d2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AnQuyChe">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#7f1d1d,#064e3b);
  min-height:100vh;
}
.hidden{display:none}

/* LAYOUT */
.container{max-width:420px;margin:auto;padding:20px}
.card{
  background:white;
  border-radius:22px;
  padding:20px;
  box-shadow:0 25px 50px rgba(0,0,0,.25);
}
h2{margin:0 0 6px}
.sub{font-size:13px;color:#555}

/* FORM */
input,select{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#b91c1c;
  color:white;
  font-weight:600;
  margin-top:14px;
}
button.secondary{
  background:#334155;
}
.day{font-weight:700;margin-top:14px}

/* MANAGER */
.section{margin-top:18px}
.shiftBox{
  background:#f1f5f9;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}
.badge{
  display:inline-block;
  background:#14532d;
  color:white;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  margin:4px 4px 0 0;
}

/* COUNTDOWN */
.countdown{
  margin-top:12px;
  padding:14px;
  border-radius:16px;
  background:#ecfdf5;
  text-align:center;
  border:2px solid #10b981;
}
.countdown.warn{
  background:#fff7ed;
  border-color:#f97316;
}
.countdown.danger{
  background:#fef2f2;
  border-color:#dc2626;
}
.cd-label{
  font-size:13px;
  color:#555;
  margin-bottom:6px;
}
#countdownTime{
  font-size:26px;
  font-weight:700;
  letter-spacing:1px;
}

/* FOOTER */
footer{
  text-align:center;
  margin-top:16px;
  font-size:12px;
  color:#eee
}
</style>
</head>

<body>

<div class="container" id="app">
  <div class="card">
    <h2>ÄÄƒng kÃ½ ca lÃ m</h2>
    <div class="sub">Tuáº§n hiá»‡n táº¡i â€¢ An Quy Cháº¿</div>
    <div id="lockStatus" class="sub"></div>

    <!-- COUNTDOWN -->
    <div id="countdownCard" class="countdown">
      <div class="cd-label">â³ Thá»i gian cÃ²n láº¡i Ä‘á»ƒ Ä‘Äƒng kÃ½</div>
      <div id="countdownTime">-- : -- : -- : --</div>
    </div>

    <input id="name" placeholder="Nháº­p tÃªn nhÃ¢n viÃªn">

    <div id="form"></div>

    <button id="submitBtn">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>
    <button id="managerBtn" class="secondary">ğŸ” Quáº£n lÃ½</button>
  </div>

  <div class="card section hidden" id="managerBox">
    <h2>Tá»•ng há»£p Ä‘Äƒng kÃ½ ca lÃ m</h2>

    <input id="pin" placeholder="Nháº­p mÃ£ PIN quáº£n lÃ½">
    <button id="loginManager">ÄÄƒng nháº­p quáº£n lÃ½</button>

    <div id="summary"></div>

    <button id="clearBtn" class="secondary">
      XÃ³a toÃ n bá»™ lá»‹ch tuáº§n nÃ y
    </button>
  </div>

  <footer>Â© 2025 An Quy Cháº¿ â€¢ Developed by ÄÃ o ÄÄƒng TÃ¹ng</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL:"https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = getDatabase(app);

/* DATA */
const DAYS=["T2","T3","T4","T5","T6","T7","CN"];
const SHIFTS=["C1","C2","C3","F1","F2","2C(C1+C2)","2C(C2+C3)"];

/* TIME LOCK â€“ LOGIC Gá»C */
function isRegistrationLocked(){
  const n=new Date();
  const d=n.getDay(), h=n.getHours(), m=n.getMinutes();
  if(d===5 && (h>20 || (h===20 && m>=0))) return true;
  if(d===6 || d===0) return true;
  return false;
}

/* STATUS */
const lockStatus=document.getElementById("lockStatus");
lockStatus.style.fontWeight="600";
if(isRegistrationLocked()){
  lockStatus.textContent="â›” Äang khÃ³a Ä‘Äƒng kÃ½ â€¢ Má»Ÿ láº¡i Thá»© 2";
  lockStatus.style.color="#b91c1c";
}else{
  lockStatus.textContent="âœ… Äang má»Ÿ Ä‘Äƒng kÃ½ â€¢ KhÃ³a lÃºc 20:00 Thá»© 6";
  lockStatus.style.color="#14532d";
}

/* COUNTDOWN */
const cdCard=document.getElementById("countdownCard");
const cdTime=document.getElementById("countdownTime");
const submitBtn=document.getElementById("submitBtn");

function getLockTime(){
  const now=new Date();
  const lock=new Date(now);
  const diff=5-now.getDay();
  lock.setDate(now.getDate()+diff);
  lock.setHours(20,0,0,0);
  return lock;
}
const lockTime=getLockTime();

function updateCountdown(){
  const now=new Date();
  const diff=lockTime-now;

  if(diff<=0){
    cdTime.innerText="ÄÃƒ KHÃ“A";
    cdCard.className="countdown danger";
    submitBtn.disabled=true;
    return;
  }

  const d=Math.floor(diff/(1000*60*60*24));
  const h=Math.floor(diff/(1000*60*60))%24;
  const m=Math.floor(diff/(1000*60))%60;
  const s=Math.floor(diff/1000)%60;

  cdTime.innerText=
    `${d} : ${h.toString().padStart(2,"0")} : ${m.toString().padStart(2,"0")} : ${s.toString().padStart(2,"0")}`;

  cdCard.className="countdown";
  if(diff<1000*60*30) cdCard.className="countdown danger";
  else if(diff<1000*60*120) cdCard.className="countdown warn";
}
setInterval(updateCountdown,1000);
updateCountdown();

/* FORM */
const form=document.getElementById("form");
DAYS.forEach(d=>{
  form.innerHTML+=`
    <div class="day">${d}</div>
    <select id="${d}">
      <option value="">KhÃ´ng Ä‘Äƒng kÃ½</option>
      ${SHIFTS.map(s=>`<option>${s}</option>`).join("")}
    </select>
  `;
});

/* SUBMIT */
document.getElementById("submitBtn").onclick=async()=>{
  const ten=document.getElementById("name").value.trim();
  if(!ten) return alert("Vui lÃ²ng nháº­p tÃªn");

  if(isRegistrationLocked())
    return alert("â›” ÄÃ£ khÃ³a Ä‘Äƒng kÃ½. Má»Ÿ láº¡i Thá»© 2.");

  const lich={};
  DAYS.forEach(d=>{
    const v=document.getElementById(d).value;
    if(v) lich[d]=v;
  });
  if(!Object.keys(lich).length)
    return alert("Báº¡n chÆ°a Ä‘Äƒng kÃ½ ca nÃ o");

  await set(ref(db,"dangKy/"+ten),{lich});
  alert("ÄÃ£ gá»­i Ä‘Äƒng kÃ½ ca lÃ m");
};

/* MANAGER */
document.getElementById("managerBtn").onclick=()=>{
  document.getElementById("managerBox").classList.remove("hidden");
};

document.getElementById("loginManager").onclick=async()=>{
  if(document.getElementById("pin").value!=="2005")
    return alert("MÃ£ PIN khÃ´ng Ä‘Ãºng");

  const summary=document.getElementById("summary");
  summary.innerHTML="";
  const snap=await get(ref(db,"dangKy"));
  if(!snap.exists()){
    summary.innerHTML="<p>ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘Äƒng kÃ½</p>";
    return;
  }

  const sum={};
  snap.forEach(n=>{
    const ten=n.key;
    const lich=n.val().lich||{};
    Object.entries(lich).forEach(([d,c])=>{
      sum[d]??={};
      sum[d][c]??=[];
      sum[d][c].push(ten);
    });
  });

  DAYS.forEach(day=>{
    if(!sum[day]) return;
    summary.innerHTML+=`<div class="day">${day}</div>`;
    SHIFTS.forEach(shift=>{
      if(!sum[day][shift]) return;
      summary.innerHTML+=`
        <div class="shiftBox">
          <b>${shift}</b><br>
          ${sum[day][shift].map(n=>`<span class="badge">${n}</span>`).join("")}
        </div>
      `;
    });
  });
};

/* CLEAR */
document.getElementById("clearBtn").onclick=async()=>{
  if(confirm("XÃ³a toÃ n bá»™ Ä‘Äƒng kÃ½ tuáº§n nÃ y?")){
    await remove(ref(db,"dangKy"));
    location.reload();
  }
};
</script>

</body>
</html>
