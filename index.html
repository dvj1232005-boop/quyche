<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Quy Chế – Đăng ký ca làm</title>
<meta name="theme-color" content="#b91c1c">

<style>
/* ================= RESET ================= */
*{box-sizing:border-box}

/* ================= BASE ================= */
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#7f1d1d,#064e3b);
  min-height:100vh;
}
.hidden{display:none}

/* ================= INTRO ================= */
#intro{
  position:fixed;
  inset:0;
  background:#b91c1c;
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  animation:introFade 0.8s ease forwards;
  animation-delay:1.6s;
}
.intro-logo{
  width:140px;
  height:auto;
  opacity:0;
  transform:scale(.75);
  animation:logoPop 0.9s cubic-bezier(.2,.8,.2,1) forwards;
}
@keyframes logoPop{
  to{opacity:1;transform:scale(1)}
}
@keyframes introFade{
  to{opacity:0;visibility:hidden}
}

/* ================= LAYOUT ================= */
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.card{
  background:#fff;
  border-radius:22px;
  padding:20px;
  box-shadow:0 25px 50px rgba(0,0,0,.25);
}
h2{
  margin:0 0 6px;
  font-size:22px;
}
.sub{
  font-size:13px;
  color:#555;
}

/* ================= FORM ================= */
input,select{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:15px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  font-size:16px;
  font-weight:600;
  background:#b91c1c;
  color:white;
  margin-top:14px;
}
.day{
  font-weight:700;
  margin-top:14px;
}

/* ================= MANAGER ================= */
.section{margin-top:18px}
.shiftBox{
  background:#f1f5f9;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}
.badge{
  display:inline-block;
  background:#14532d;
  color:white;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  margin:4px 4px 0 0;
}

/* ================= SNOW ================= */
.snow{
  position:fixed;
  top:-10px;
  color:white;
  pointer-events:none;
  animation:fall linear infinite;
}
@keyframes fall{
  to{transform:translateY(110vh)}
}

/* ================= FOOTER ================= */
footer{
  text-align:center;
  margin-top:16px;
  font-size:12px;
  color:#eee;
}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro">
  <img src="logo.jpg" alt="An Quy Chế" class="intro-logo">
</div>

<!-- APP -->
<div class="container hidden" id="app">
  <div class="card">
    <h2>Đăng ký ca làm</h2>
    <div class="sub">Tuần hiện tại • An Quy Chế</div>

    <input id="name" placeholder="Nhập tên nhân viên">
    <input id="pin" placeholder="Nhập mã PIN quản lý" class="hidden">

    <div id="form"></div>

    <button id="submitBtn">Xác nhận đăng ký</button>
  </div>

  <div class="card section hidden" id="managerBox">
    <h2>Tổng hợp đăng ký ca làm</h2>
    <button id="clearBtn">Xóa toàn bộ lịch tuần này</button>
    <div id="summary"></div>
  </div>

  <footer>© 2025 An Quy Chế • Developed by Đào Đăng Tùng</footer>
</div>

<script type="module">
/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey:"AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL:"https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = getDatabase(app);

/* ================= DATA ================= */
const DAYS=["T2","T3","T4","T5","T6","T7","CN"];
const SHIFTS=["C1","C2","C3","2C(C1+C2)","2C(C2+C3)","F1","F2"];

/* ================= INTRO END ================= */
setTimeout(()=>{
  document.getElementById("intro").remove();
  document.getElementById("app").classList.remove("hidden");
},2600);

/* ================= SNOW ================= */
setInterval(()=>{
  const s=document.createElement("div");
  s.className="snow";
  s.innerText="❄";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=3+Math.random()*3+"s";
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),6000);
},350);

/* ================= FORM ================= */
const form=document.getElementById("form");
DAYS.forEach(d=>{
  form.innerHTML+=`
    <div class="day">${d}</div>
    <select id="${d}">
      <option value="">Không đăng ký</option>
      ${SHIFTS.map(s=>`<option>${s}</option>`).join("")}
    </select>
  `;
});

/* ================= SUBMIT ================= */
submitBtn.onclick=async()=>{
  const ten=name.value.trim();
  if(!ten) return alert("Vui lòng nhập tên");

  if(ten.toLowerCase()==="quanly"){
    pin.classList.remove("hidden");
    if(pin.value!=="2005") return alert("Mã PIN không đúng");
    showManager();
    return;
  }

  const lich={};
  DAYS.forEach(d=>{
    const v=document.getElementById(d).value;
    if(v) lich[d]=v;
  });

  if(!Object.keys(lich).length)
    return alert("Bạn chưa đăng ký ca nào");

  await set(ref(db,"dangKy/"+ten),{lich});
  alert("Đã gửi đăng ký ca làm");
};

/* ================= MANAGER ================= */
async function showManager(){
  managerBox.classList.remove("hidden");
  const snap=await get(ref(db,"dangKy"));
  const sum={};

  snap.forEach(n=>{
    const ten=n.key;
    const lich=n.val().lich||{};
    Object.entries(lich).forEach(([d,c])=>{
      sum[d]??={};
      sum[d][c]??=[];
      sum[d][c].push(ten);
    });
  });

  summary.innerHTML="";
  Object.entries(sum).forEach(([d,sh])=>{
    summary.innerHTML+=`<div class="day">${d}</div>`;
    Object.entries(sh).forEach(([c,arr])=>{
      summary.innerHTML+=`
        <div class="shiftBox">
          <b>${c}</b><br>
          ${arr.map(n=>`<span class="badge">${n}</span>`).join("")}
        </div>`;
    });
  });
}

/* ================= CLEAR ================= */
clearBtn.onclick=async()=>{
  if(confirm("Xóa toàn bộ đăng ký của tuần này?")){
    await remove(ref(db,"dangKy"));
    location.reload();
  }
};
</script>
</body>
</html>
