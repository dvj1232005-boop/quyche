<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport"
content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<title>An Quy Cháº¿ â€“ ÄÄƒng kÃ½ ca & Partner Treat</title>

<meta name="theme-color" content="#0b3d2e">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="AnQuyChe">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
*{box-sizing:border-box}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto;
  background:linear-gradient(180deg,#7f1d1d,#064e3b);
  min-height:100vh;
}
.hidden{display:none}

/* LAYOUT */
.container{max-width:420px;margin:auto;padding:20px}
.card{
  background:white;
  border-radius:22px;
  padding:20px;
  box-shadow:0 25px 50px rgba(0,0,0,.25);
}
h2{margin:0 0 6px}
.sub{font-size:13px;color:#555}

/* FORM */
input,select,textarea{
  width:100%;
  padding:14px;
  margin:10px 0;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#b91c1c;
  color:white;
  font-weight:600;
  margin-top:14px;
}
button.secondary{background:#334155}
.day{font-weight:700;margin-top:14px}

/* COUNTDOWN */
.countdown{
  margin-top:12px;
  padding:14px;
  border-radius:16px;
  background:#ecfdf5;
  text-align:center;
  border:2px solid #10b981;
}
.countdown.warn{
  background:#fff7ed;
  border-color:#f97316;
}
.countdown.danger{
  background:#fef2f2;
  border-color:#dc2626;
}
#countdownTime{
  font-size:26px;
  font-weight:700;
}

/* PARTNER */
#partnerBox{
  margin-top:14px;
  padding:14px;
  background:#f8fafc;
  border-radius:16px;
}
.codeItem{
  display:inline-block;
  background:#0f766e;
  color:white;
  padding:6px 10px;
  border-radius:10px;
  margin:4px;
  font-weight:600;
}

/* MANAGER */
.section{margin-top:18px}
.shiftBox{
  background:#f1f5f9;
  border-radius:14px;
  padding:10px;
  margin:8px 0;
}
.badge{
  display:inline-block;
  background:#14532d;
  color:white;
  padding:6px 10px;
  border-radius:999px;
  font-size:13px;
  margin:4px;
}

footer{
  text-align:center;
  margin-top:16px;
  font-size:12px;
  color:#eee
}
</style>
</head>

<body>

<div class="container">

<!-- ================= NHÃ‚N VIÃŠN ================= -->
<div class="card">
  <h2>ÄÄƒng kÃ½ ca lÃ m</h2>
  <div id="lockStatus" class="sub"></div>

  <div class="countdown" id="countdownCard">
    <div class="sub">â³ Thá»i gian cÃ²n láº¡i Ä‘á»ƒ Ä‘Äƒng kÃ½</div>
    <div id="countdownTime">--:--:--</div>
  </div>

  <input id="name" placeholder="TÃªn nhÃ¢n viÃªn (VD: ÄÃ o ÄÄƒng TÃ¹ng)">
  <input id="userPin" type="password" placeholder="PIN cÃ¡ nhÃ¢n (xem mÃ£ Partner)">

  <div id="partnerBox" class="hidden">
    <h3>ğŸ MÃ£ Partner Treat cá»§a báº¡n</h3>
    <div id="partnerCodes"></div>
  </div>

  <div id="form"></div>
  <button id="submitBtn">XÃ¡c nháº­n Ä‘Äƒng kÃ½ ca</button>
</div>

<!-- ================= QUáº¢N LÃ ================= -->
<div class="card section">
  <h2>ğŸ” Quáº£n lÃ½</h2>

  <input id="adminPin" type="password" placeholder="PIN quáº£n lÃ½">
  <button id="loginAdmin">ÄÄƒng nháº­p quáº£n lÃ½</button>

  <div id="adminBox" class="hidden">

    <hr>
    <h3>ğŸ Kho mÃ£ Partner Treat</h3>
    <textarea id="codeInput"
      placeholder="DÃ¡n danh sÃ¡ch mÃ£, má»—i dÃ²ng 1 mÃ£"></textarea>
    <button id="saveCodes" class="secondary">LÆ°u kho mÃ£</button>

    <hr>
    <h3>ğŸ‘¤ PhÃ¡t / Thu há»“i mÃ£</h3>
    <input id="staffName" placeholder="TÃªn nhÃ¢n viÃªn">
    <select id="staffType">
      <option value="parttime">Part-time (5 mÃ£)</option>
      <option value="fulltime">Full-time (10 mÃ£)</option>
    </select>
    <input id="staffPin" placeholder="Äáº·t PIN cho nhÃ¢n viÃªn (4â€“6 sá»‘)">
    <button id="assignCodes">PhÃ¡t mÃ£</button>
    <button id="revokeCodes" class="secondary">Thu há»“i mÃ£</button>

  </div>
</div>

<footer>Â© 2025 An Quy Cháº¿ â€¢ Developed by ÄÃ o ÄÄƒng TÃ¹ng</footer>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove }
from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* FIREBASE */
const app = initializeApp({
  apiKey:"AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL:"https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app"
});
const db = getDatabase(app);

/* DATA */
const DAYS=["T2","T3","T4","T5","T6","T7","CN"];
const SHIFTS=["C1","C2","C3","F1","F2","2C(C1+C2)","2C(C2+C3)"];

/* LOCK */
function isLocked(){
  const n=new Date();
  return n.getDay()>=6 || (n.getDay()==5 && n.getHours()>=20);
}
document.getElementById("lockStatus").innerText=
  isLocked()?"â›” ÄÃ£ khÃ³a Ä‘Äƒng kÃ½":"âœ… Äang má»Ÿ Ä‘Äƒng kÃ½";

/* COUNTDOWN */
const cd=document.getElementById("countdownCard");
const cdt=document.getElementById("countdownTime");
const btn=document.getElementById("submitBtn");

function getLockTime(){
  const now=new Date();
  const lock=new Date(now);
  lock.setDate(now.getDate()+(5-now.getDay()));
  lock.setHours(20,0,0,0);
  return lock;
}
const lockTime=getLockTime();
setInterval(()=>{
  const diff=lockTime-new Date();
  if(diff<=0){
    cdt.innerText="ÄÃƒ KHÃ“A";
    btn.disabled=true;
    cd.className="countdown danger";
    return;
  }
  const h=Math.floor(diff/36e5);
  const m=Math.floor(diff/6e4)%60;
  const s=Math.floor(diff/1e3)%60;
  cdt.innerText=
    `${h}:${m.toString().padStart(2,"0")}:${s.toString().padStart(2,"0")}`;
  cd.className=
    diff<18e5?"countdown danger":diff<72e5?"countdown warn":"countdown";
},1000);

/* FORM */
const form=document.getElementById("form");
DAYS.forEach(d=>{
  form.innerHTML+=`
    <div class="day">${d}</div>
    <select id="${d}">
      <option value="">KhÃ´ng Ä‘Äƒng kÃ½</option>
      ${SHIFTS.map(s=>`<option>${s}</option>`).join("")}
    </select>`;
});

/* SUBMIT CA */
btn.onclick=async()=>{
  if(isLocked()) return alert("ÄÃ£ khÃ³a Ä‘Äƒng kÃ½");
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("ChÆ°a nháº­p tÃªn");
  const lich={};
  DAYS.forEach(d=>{
    const v=document.getElementById(d).value;
    if(v) lich[d]=v;
  });
  if(!Object.keys(lich).length)
    return alert("ChÆ°a chá»n ca");
  await set(ref(db,"dangKy/"+name),{lich});
  alert("ÄÃ£ gá»­i Ä‘Äƒng kÃ½ ca");
};

/* NHÃ‚N VIÃŠN XEM MÃƒ */
const partnerBox=document.getElementById("partnerBox");
const partnerCodes=document.getElementById("partnerCodes");

document.getElementById("userPin").addEventListener("change",async()=>{
  const ten=document.getElementById("name").value.trim();
  const pin=document.getElementById("userPin").value.trim();
  if(!ten||!pin) return;
  const snap=await get(ref(db,"partnerCodes/assigned/"+ten));
  if(!snap.exists()) return alert("ChÆ°a Ä‘Æ°á»£c cáº¥p mÃ£");
  if(snap.val().pin!==pin) return alert("Sai PIN");
  partnerBox.classList.remove("hidden");
  partnerCodes.innerHTML="";
  snap.val().codes.forEach(c=>{
    partnerCodes.innerHTML+=`<span class="codeItem">${c}</span>`;
  });
});

/* ADMIN */
document.getElementById("loginAdmin").onclick=()=>{
  if(document.getElementById("adminPin").value==="2005")
    document.getElementById("adminBox").classList.remove("hidden");
  else alert("Sai PIN quáº£n lÃ½");
};

/* SAVE POOL */
document.getElementById("saveCodes").onclick=async()=>{
  const raw=document.getElementById("codeInput").value.trim();
  raw.split("\n").forEach(c=>{
    if(c) set(ref(db,"partnerCodes/pool/"+c.trim()),true);
  });
  alert("ÄÃ£ lÆ°u kho mÃ£");
};

/* ASSIGN */
document.getElementById("assignCodes").onclick=async()=>{
  const ten=document.getElementById("staffName").value.trim();
  const type=document.getElementById("staffType").value;
  const pin=document.getElementById("staffPin").value.trim();
  if(!ten||!/^\d{4,6}$/.test(pin)) return alert("Thiáº¿u tÃªn hoáº·c PIN");
  const need=type==="fulltime"?10:5;
  const poolSnap=await get(ref(db,"partnerCodes/pool"));
  if(!poolSnap.exists()) return alert("Kho mÃ£ trá»‘ng");
  const pool=Object.keys(poolSnap.val());
  if(pool.length<need) return alert("KhÃ´ng Ä‘á»§ mÃ£");
  const give=pool.slice(0,need);
  await set(ref(db,"partnerCodes/assigned/"+ten),{type,pin,codes:give});
  for(const c of give)
    await remove(ref(db,"partnerCodes/pool/"+c));
  alert("ÄÃ£ phÃ¡t mÃ£ cho "+ten);
};

/* REVOKE */
document.getElementById("revokeCodes").onclick=async()=>{
  const ten=document.getElementById("staffName").value.trim();
  const snap=await get(ref(db,"partnerCodes/assigned/"+ten));
  if(!snap.exists()) return alert("NgÆ°á»i nÃ y chÆ°a cÃ³ mÃ£");
  for(const c of snap.val().codes)
    await set(ref(db,"partnerCodes/pool/"+c),true);
  await remove(ref(db,"partnerCodes/assigned/"+ten));
  alert("ÄÃ£ thu há»“i mÃ£");
};
</script>

</body>
</html>
