<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>An Quy Ch·∫ø ‚Äì ƒêƒÉng k√Ω ca l√†m</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b3d2e">

<style>
:root{
  --bg:linear-gradient(180deg,#e9fff6,#f7fbff);
  --card:#ffffff;
  --text:#0f172a;
  --accent:#0b8f6a;
}
body.dark{
  --bg:linear-gradient(180deg,#071e17,#04140f);
  --card:#0f2a22;
  --text:#ecfdf5;
  --accent:#3bffb4;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:var(--bg);
  color:var(--text);
  min-height:100vh;
  display:flex;
  justify-content:center;
}

/* ===== INTRO ===== */
#intro{
  position:fixed;
  inset:0;
  background:linear-gradient(180deg,#0b3d2e,#062a20);
  z-index:9999;
  display:flex;
  justify-content:center;
  align-items:center;
  animation:introOut 1s ease forwards;
  animation-delay:3s;
}
.intro-box{text-align:center;color:white}
.intro-logo{
  width:120px;
  border-radius:24px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
  animation:logoPop 1.2s ease;
}
@keyframes logoPop{
  from{transform:scale(.6);opacity:0}
  to{transform:scale(1);opacity:1}
}
@keyframes introOut{
  to{opacity:0;visibility:hidden}
}

/* ===== LAYOUT ===== */
.container{
  width:100%;
  max-width:420px;
  padding:20px;
}
.card{
  background:var(--card);
  border-radius:24px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.15);
}
.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
}
.toggle{cursor:pointer;font-size:20px}

/* ===== FORM ===== */
input,select{
  width:100%;
  padding:12px;
  margin:10px 0;
  border-radius:14px;
  border:1px solid #ccc;
  font-size:15px;
}
table{width:100%}
td{padding:6px 0}
.day{font-weight:600}

button{
  margin-top:14px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:linear-gradient(135deg,#e53935,#ff6b6b);
  color:white;
  font-size:16px;
  font-weight:700;
}

/* ===== MANAGER ===== */
.manager-box{
  margin-top:16px;
  background:rgba(0,0,0,.05);
  padding:14px;
  border-radius:14px;
}

/* ===== SNOW ===== */
.snow{
  position:fixed;
  top:-10px;
  color:white;
  font-size:10px;
  animation:fall linear forwards;
  z-index:5;
}
@keyframes fall{
  to{transform:translateY(110vh);opacity:0}
}

/* ===== FOOTER ===== */
.footer{
  text-align:center;
  font-size:12px;
  opacity:.6;
  margin-top:16px;
}
</style>
</head>

<body>

<!-- INTRO -->
<div id="intro">
  <div class="intro-box">
    <img src="logo.jpg" class="intro-logo">
    <h2>An Quy Ch·∫ø</h2>
    <p>H·ªá th·ªëng ƒëƒÉng k√Ω ca l√†m</p>
  </div>
</div>

<div class="container">
  <div class="card">
    <div class="header">
      <h3>üìÖ ƒêƒÉng k√Ω ca l√†m</h3>
      <div class="toggle" onclick="toggleTheme()">üåô</div>
    </div>

    <input id="name" placeholder="Nh·∫≠p t√™n (Qu·∫£n l√Ω: QuanLy)">

    <table id="schedule"></table>

    <button onclick="submit()">X√°c nh·∫≠n</button>

    <div id="managerBox" class="manager-box" style="display:none"></div>
  </div>

  <div class="footer">
    ¬© 2025 An Quy Ch·∫ø ‚Ä¢ ƒê√†o ƒêƒÉng T√πng
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

/* ===== FIREBASE ===== */
const app = initializeApp({
  apiKey:"AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL:"https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId:"an-quy"
});
const db = getDatabase(app);

/* ===== TIME ===== */
function getWeekKey(){
  const d=new Date();
  const first=new Date(d.getFullYear(),0,1);
  const week=Math.ceil((((d-first)/86400000)+first.getDay()+1)/7);
  return `${d.getFullYear()}-W${week}`;
}
const WEEK = getWeekKey();

/* ===== CA ===== */
const days=["T2","T3","T4","T5","T6","T7","CN"];
const shifts=["C1","C2","C3","2C(C1+C2)","2C(C2+C3)","F1","F2"];
const table=document.getElementById("schedule");

days.forEach(d=>{
  table.innerHTML+=`
    <tr>
      <td class="day">${d}</td>
      <td>
        <select id="${d}">
          <option value="">‚Äî Kh√¥ng l√†m ‚Äî</option>
          ${shifts.map(s=>`<option>${s}</option>`).join("")}
        </select>
      </td>
    </tr>`;
});

/* ===== SUBMIT ===== */
window.submit = async()=>{
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("Ch∆∞a nh·∫≠p t√™n");

  /* MANAGER */
  if(name.toLowerCase()==="quanly"){
    const pin=prompt("Nh·∫≠p m√£ PIN qu·∫£n l√Ω");
    if(pin!=="2005") return alert("Sai PIN");

    const box=document.getElementById("managerBox");
    box.style.display="block";
    box.innerHTML="<h4>T·ªïng h·ª£p l·ªãch</h4>";

    const snap=await get(ref(db,`dangKy/${WEEK}`));
    if(!snap.exists()){
      box.innerHTML+="<p>Ch∆∞a c√≥ d·ªØ li·ªáu</p>";
      return;
    }

    const grouped={};
    snap.forEach(n=>{
      const lich=n.val().lich||{};
      Object.keys(lich).forEach(d=>{
        const k=`${d} ‚Äì ${lich[d]}`;
        grouped[k]=grouped[k]||[];
        grouped[k].push(n.key);
      });
    });

    Object.keys(grouped).forEach(k=>{
      box.innerHTML+=`<div>${k}: ${grouped[k].join(", ")}</div>`;
    });

    box.innerHTML+=`<button onclick="clearWeek()">X√≥a tu·∫ßn</button>`;
    return;
  }

  /* STAFF */
  const lich={};
  days.forEach(d=>{
    const v=document.getElementById(d).value;
    if(v) lich[d]=v;
  });
  if(!Object.keys(lich).length) return alert("Ch∆∞a ch·ªçn ca");

  await set(ref(db,`dangKy/${WEEK}/${name}`),{lich});
  alert("ƒê√£ g·ª≠i l·ªãch");
};

/* ===== CLEAR ===== */
window.clearWeek = async()=>{
  if(confirm("X√≥a to√†n b·ªô l·ªãch tu·∫ßn n√†y?")){
    await remove(ref(db,`dangKy/${WEEK}`));
    location.reload();
  }
};

window.toggleTheme=()=>document.body.classList.toggle("dark");

/* ===== SNOW ===== */
setInterval(()=>{
  const s=document.createElement("div");
  s.className="snow";
  s.textContent="‚ùÑ";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=(3+Math.random()*4)+"s";
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),7000);
},350);

/* ===== SW ===== */
if("serviceWorker"in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>
