<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>An Quy Cháº¿ â€“ ÄÄƒng kÃ½ ca</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f5132">

<style>
:root{
  --bg:#0f5132;
  --card:#ffffff;
  --text:#0f172a;
  --accent:#198754;
}
body{
  margin:0;
  font-family:system-ui,-apple-system;
  background:linear-gradient(180deg,#0f5132,#198754);
  color:var(--text);
  min-height:100vh;
}
.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}
.card{
  background:var(--card);
  border-radius:22px;
  padding:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.2);
}
h2,h3{margin:10px 0}
input,select{
  width:100%;
  padding:12px;
  border-radius:14px;
  border:1px solid #ccc;
  margin:8px 0;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:16px;
  background:#c62828;
  color:white;
  font-weight:700;
  margin-top:10px;
}
.manager{
  margin-top:20px;
}
.shift-card{
  background:#f3f6f9;
  border-radius:14px;
  padding:12px;
  margin:10px 0;
}
.shift-title{
  font-weight:700;
  color:#c62828;
}
.user-list{
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin-top:8px;
}
.user-chip{
  background:#1b5e20;
  color:white;
  padding:6px 12px;
  border-radius:999px;
  font-size:13px;
}
.footer{
  text-align:center;
  color:white;
  opacity:.7;
  font-size:13px;
  margin-top:20px;
}
.snow{
  position:fixed;
  top:-10px;
  color:white;
  pointer-events:none;
  animation:fall linear infinite;
}
@keyframes fall{
  to{transform:translateY(110vh)}
}
</style>
</head>

<body>
<div class="container">
  <div class="card">
    <h2>ğŸ“… ÄÄƒng kÃ½ ca lÃ m</h2>
    <input id="name" placeholder="Nháº­p tÃªn (Quáº£n lÃ½ nháº­p QuanLy)">
    <div id="form"></div>
    <button onclick="submit()">XÃ¡c nháº­n Ä‘Äƒng kÃ½</button>

    <div id="managerBox" class="manager" style="display:none"></div>
  </div>

  <div class="footer">
    Â© 2025 An Quy Cháº¿ â€¢ Developed by ÄÃ o ÄÄƒng TÃ¹ng
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
import { getDatabase, ref, set, get, remove } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-database.js";

const app = initializeApp({
  apiKey: "AIzaSyCK6yfVr9VBMGwhbvYMXkJqMoRjo4Om2LM",
  databaseURL: "https://an-quy-default-rtdb.asia-southeast1.firebasedatabase.app",
});
const db = getDatabase(app);

const days=["T2","T3","T4","T5","T6","T7","CN"];
const shifts=["C1","C2","C3","2C(C1+C2)","2C(C2+C3)","F1","F2"];
const form=document.getElementById("form");

days.forEach(d=>{
  form.innerHTML+=`
    <label>${d}</label>
    <select id="${d}">
      <option value="">KhÃ´ng lÃ m</option>
      ${shifts.map(s=>`<option>${s}</option>`).join("")}
    </select>
  `;
});

function mondayKey(){
  const d=new Date();
  const day=d.getDay();
  const diff=(day===0?-6:1)-day;
  d.setDate(d.getDate()+diff);
  d.setHours(0,0,0,0);
  return d.getTime();
}
const WEEK=mondayKey();

window.submit=async()=>{
  const name=document.getElementById("name").value.trim();
  if(!name) return alert("ChÆ°a nháº­p tÃªn");

  if(name.toLowerCase()==="quanly"){
    const pin=prompt("Nháº­p PIN quáº£n lÃ½");
    if(pin!=="2005") return alert("Sai PIN");

    document.getElementById("managerBox").style.display="block";
    document.getElementById("managerBox").innerHTML=`
      <h2>ğŸ“Š Tá»•ng há»£p Ä‘Äƒng kÃ½</h2>
      <button onclick="clearWeek()">XÃ³a toÃ n bá»™ lá»‹ch tuáº§n nÃ y</button>
    `;

    const snap=await get(ref(db,"dangKy/"+WEEK));
    if(!snap.exists()) return;

    const result={};
    snap.forEach(u=>{
      const lich=u.val().lich||{};
      Object.keys(lich).forEach(d=>{
        result[d]??={};
        result[d][lich[d]]??=[];
        result[d][lich[d]].push(u.key);
      });
    });

    Object.keys(result).forEach(d=>{
      managerBox.innerHTML+=`<h3>ğŸ“… ${d}</h3>`;
      Object.keys(result[d]).forEach(ca=>{
        managerBox.innerHTML+=`
          <div class="shift-card">
            <div class="shift-title">â° ${ca}</div>
            <div class="user-list">
              ${result[d][ca].map(n=>`<span class="user-chip">${n}</span>`).join("")}
            </div>
          </div>
        `;
      });
    });
    return;
  }

  const lich={};
  days.forEach(d=>{
    const v=document.getElementById(d).value;
    if(v) lich[d]=v;
  });
  await set(ref(db,"dangKy/"+WEEK+"/"+name),{lich});
  alert("ÄÄƒng kÃ½ thÃ nh cÃ´ng");
};

window.clearWeek=async()=>{
  if(confirm("XÃ³a toÃ n bá»™ lá»‹ch tuáº§n nÃ y?")){
    await remove(ref(db,"dangKy/"+WEEK));
    location.reload();
  }
};

// snow
setInterval(()=>{
  const s=document.createElement("div");
  s.className="snow";
  s.textContent="â„";
  s.style.left=Math.random()*100+"vw";
  s.style.animationDuration=5+Math.random()*5+"s";
  document.body.appendChild(s);
  setTimeout(()=>s.remove(),10000);
},400);
</script>
</body>
</html>
